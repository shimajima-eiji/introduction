---
layout: post
title: GitでRebase運用してたら血を吐きそうになった話
description: Git Rebaseを採用しているプロジェクトはすげぇな、と改めて思いました。運用コストが高すぎます。
categories:
  - tech
tags:
  - Git
img: common/research.jpg
---
[まさしくこのrebaseケース](https://frasco.io/why-you-should-stop-using-git-rebase-535fa30d7e25)に当たってしまいました。
具体的には_draftsから_postsに移動したファイルがある場合、rebaseにより_draftsに移動したファイルが復活してしまいます。
これの変更をなかった事にするため、`git reflog`で削除する事も考えたんですが、もう面倒くさいのでいいやと。

jekyllで_draftを使うならrebaseはおすすめできません。

## 経緯
バカ正直にrebaseすればいいんですが、draftsからpostsに移行するまでの間はずっと競合し続けるので、これをなんとかしないといけない。

![問題箇所]({{site.baseurl}}/{{site.data.path.img}}/2019/11/gitflow_cross.png)
![ブランチが統合されていない図]({{site.baseurl}}/{{site.data.path.img}}/2019/11/gitflow.png)

同じコミットメッセージが複数あることでなんとなく察せるかと思いますが、同じことをやっているので履歴の内容としては不適当です。
履歴を正すところから始めないと（開発はともかく）運用としてはどうにもならないです。
こういう事をやると運用負荷がハネ上がるんですが、管理でどうにかするしかないのも実際の話。
もちろん、業務でやるならこんな雑な対応はしませんがgitのために運用を悩まされたくないのでforce pushで押し切ります。

## 開発の歴史をどうやって維持するか？
git logで管理するのではなく、githubで管理するというアプローチです。
つまり、小規模なコミットログをプルリクエストにすることで、githubに履歴を作っていくという寸法です。

## きっかけはGitlabのメジャーアップデート
当時Gitlab Version6系をVer10にアップデートしたい、というすんごい要件にぶち当たった時の問題でした。
github privateであればそういった細かい話は全部投げられたんですが、gitlabは全部こちらで管理しなければならないため、
gitのlogは消したくない

### Gitlabで.gitをどうやって管理しているのか？
実態はDBにあります。
メジャーバージョンアップによりDBのマイグレーションが必要になります。

うまいことやればDBを保持した状態でなんとかできるんですが、そのために頑張るんじゃなくて運用環境を整備する方に手を尽くしたほうが前向きな対応かなと思います。
**難しいものを難しく使おうとすると、いずれシステムを捨てる時に、捨て方が分からなくて困ります。**

今回は基幹部分を全部GitHubにもたせているので、force pushしてもGitHubに履歴は残っています。


https://blog.freelance-jp.org/20191023-5917/
