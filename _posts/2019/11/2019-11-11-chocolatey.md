---
layout: post
title: 【Windowsの環境を簡単に移行したい】chocolateyを実運用してみる
description: Windowsのパッケージ管理を考える。MacOSでいうbrewやymlなどaptのようなPackage Managementを実現する方法を実践で解説！
categories:
  - tech
tags:
  - Windows
  - パッケージ管理
img: 2019/11/chocolatey.jpg
---

## Windowsの引っ越しは大変！
先日、マシンを換装する際にファイルの移行で非常に苦労しました。
わざわざサイトまで行ってインストーラーをダウンロードして実行する、というプロセスをいくつもやっているととても手間臭い！
ひとつふたつではなく、大量にあるわけです。

移行ツールなど色々ありますが、できたらエンジニアライクにやりたい！ということでchocolateyを使ってみます。

## chocolateyとは
Windowsのパッケージ管理・エコシステムで、MacOSでいうbrewやymlなどaptのようなものです。
chromeやらfirefoxやら、インストールしているものをコマンド一発でいい感じにやってくれるツール、ぐらいの認識で良いと思います。

では、ここから実際に運用してみたお話です。

## Windowsアップデート
理由がなければ真っ先に走らせましょう。
他が終わってもWindows Updateが終わらないことには再起動もできません。
たとえば、Windows10ならVersion19.03が入るまでは何もできません。
そして、終わるまでにそのまま待ちましょう。

おそらく、再起動を要求されるので、これも承諾します。
以下の作業は再起動後を想定しています。

今回、クリーンインストールをしたので最初のアップデートが終わっても、アップデートしたファイルのアップデートがダウンロードされて再起動を求められる、というパターンがありました。
具体的にはWindow Version19.03の更新パッケージを入れた後でした。

## chocolatey本体のインストール
コマンドプロンプトを管理者権限で開いて以下のコマンドをコピペ。
```
@powershell -NoProfile -ExecutionPolicy unrestricted -Command "iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1'))" && SET PATH=%PATH%;%systemdrive%\chocolatey\bin
```
なんか大量のWarningメッセージは出るけど無視しましょう、
というのも、chocolateyを実施するときちんと入ってるっぽいですが、この辺りは要確認のこと。

## パッケージインストール
予め作成しておいたパッケージがあれば、
```
cinst chocolatey.config
```
でまとめて入りますし、なければ`cinst （パッケージ）`とか`chocolatey install （パッケージ）`でガシガシ入れていきましょう。
一つ二つならまだしも、頻繁に使うと手間なので、まとまったタイミングでxmlにアウトプットして別管理しておくことをオススメします。

インストーラー側からメッセージがちょいちょい上がってくるので、yとかaとかで進めましょう。
面倒くさかったら聞かれてもないのにy[enter]y[enter]を何回か入力しておいてもいいかもしれません。[^1]

## Windowsの設定
適宜対応のものなのでやってもやらなくても良いです。
私はHyper-VとWindows Subsystem for LInuxは必需品なので、この二つを入れてます。
なお、**Windows Subsystem for LInuxをchocolateyで入れると環境によっては致命的なエラーになり復旧が不可能になります。**

あと、宗教上の理由でキー設定がMicrosoft IMEではなくATOK。
フォルダオプションはtablacusを使うので設定するほどでもないかなぁ。

## その他サードパーティー製のもの
こちらも必要に応じて入れていきましょう。
tortoise gitを使っているなら、languageパッケージをわざわざダウンロードしないといけないです。
開き直ってenglish版を使いこなせるようになってしまうのもアリだと思います。
とはいえ面倒くさいので、chocolateyで管理してくれないかなぁ。

いっそのこと、これらのファイルだけ別管理するという手もなくはないです。

## 入った後に設定するもの
私の場合、tablacusとVSCodeのSettings.jsonをgitで管理しているので、これらを持ってくる必要があります。
また、Vivaldiの設定をコミュニティにログインして持ってきたりとか、マウスジェスチャーを再設定したり、やることは多いです。
それでもchocolateyがあるとだいぶ捗りますね。

## ありがちな失敗
Windows Updateがすべて完了する前にパッケージを入れると、本来必要でないものを入れることになるのでレジストリがおかしな事になる可能性があります。
分かりやすいのは、グラフィックドライバーなどWindows Updateに含まれるものをわざわざ入れなおしたりなど。Geforceユーザーは多いだろうと思いますが、こういう専用ドライバーが多いです。
WSLもこちらに該当します。

## 注釈
[^1]: 【yesキー先行入力】何がインストールされているのか自己管理できている場合に限ります。当然責任はとれません…
